<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Image Marker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: #f0f2f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: #4a6fa5;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            position: relative;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #4a6fa5;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e9ecef;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: #4a6fa5;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .file-input {
            width: 100%;
            padding: 15px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .marker-types {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .marker-type {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .marker-type.active {
            border-color: #4a6fa5;
            background: #4a6fa5;
            color: white;
        }

        .marker-type i {
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        .marker-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }

        .marker-item {
            padding: 8px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .marker-item:hover {
            background: #e9ecef;
        }

        .marker-item.selected {
            background: #d1ecf1;
        }

        .marker-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .marker-item-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
        }

        .marker-item-icon.info { background: #17a2b8; }
        .marker-item-icon.link { background: #28a745; }
        .marker-item-icon.video { background: #dc3545; }
        .marker-item-icon.audio { background: #ffc107; }

        .marker-actions {
            display: flex;
            gap: 5px;
        }

        .marker-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #6c757d;
        }

        .marker-action-btn:hover {
            color: #495057;
        }

        .image-container {
            width: 100%;
            height: 500px;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #imageDisplay {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
        }

        .marker {
            position: absolute;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            z-index: 10;
        }

        .marker:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .marker.selected {
            border: 3px solid white;
            box-shadow: 0 0 0 2px #4a6fa5;
        }

        .marker.info { background: #17a2b8; }
        .marker.link { background: #28a745; }
        .marker.video { background: #dc3545; }
        .marker.audio { background: #ffc107; }

        .marker-popup {
            position: absolute;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: none;
            z-index: 100;
            max-width: 350px;
            min-width: 250px;
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .popup-title {
            color: #4a6fa5;
            margin: 0;
            flex: 1;
        }

        .popup-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
        }

        .popup-content {
            margin-bottom: 15px;
        }

        .popup-description {
            color: #495057;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .popup-link {
            display: block;
            color: #4a6fa5;
            text-decoration: none;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .popup-link:hover {
            text-decoration: underline;
        }

        .popup-media {
            width: 100%;
            margin-top: 10px;
        }

        .popup-video, .popup-audio {
            width: 100%;
            border-radius: 4px;
        }

        .hidden {
            display: none;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marker-alt"></i> Interactive Image Marker</h1>
            <p>Add markers to your images with information, links, and media</p>
        </header>

        <div class="app-container">
            <div class="sidebar">
                <div class="section">
                    <h3><i class="fas fa-upload"></i> Upload Image</h3>
                    <div class="file-input" id="fileInput">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <div>Click to upload image</div>
                    </div>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>

                <div class="section">
                    <h3><i class="fas fa-map-pin"></i> Add Marker</h3>
                    <div class="marker-types">
                        <div class="marker-type active" data-type="info">
                            <i class="fas fa-info-circle"></i>
                            <div>Info</div>
                        </div>
                        <div class="marker-type" data-type="link">
                            <i class="fas fa-link"></i>
                            <div>Link</div>
                        </div>
                        <div class="marker-type" data-type="video">
                            <i class="fas fa-video"></i>
                            <div>Video</div>
                        </div>
                        <div class="marker-type" data-type="audio">
                            <i class="fas fa-volume-up"></i>
                            <div>Audio</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="markerTitle" class="form-control" placeholder="Marker title">
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="markerDescription" class="form-control" placeholder="Marker description"></textarea>
                    </div>

                    <div class="form-group link-field">
                        <label>Link URL</label>
                        <input type="url" id="markerLink" class="form-control" placeholder="https://example.com">
                    </div>

                    <div class="form-group video-field">
                        <label>Video URL</label>
                        <input type="url" id="markerVideo" class="form-control" placeholder="https://youtube.com/watch?v=...">
                        <small style="color: #666; font-size: 12px;">Supports YouTube, Vimeo, and direct video links</small>
                    </div>

                    <div class="form-group audio-field">
                        <label>Audio URL</label>
                        <input type="url" id="markerAudio" class="form-control" placeholder="https://example.com/audio.mp3">
                        <small style="color: #666; font-size: 12px;">Supports MP3, WAV, and other audio formats</small>
                    </div>

                    <button id="saveMarker" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Marker
                    </button>
                    <button id="deleteMarker" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-trash"></i> Delete Marker
                    </button>
                </div>

                <div class="section">
                    <h3><i class="fas fa-list"></i> Markers</h3>
                    <div class="marker-list" id="markerList">
                        <div class="empty-state">No markers added</div>
                    </div>
                    <button id="clearMarkers" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>

                <div class="section">
                    <h3><i class="fas fa-project-diagram"></i> Projects</h3>
                    <button id="saveProject" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Project
                    </button>
                    <button id="loadProject" class="btn btn-primary">
                        <i class="fas fa-folder-open"></i> Load Project
                    </button>
                    <button id="exportHTML" class="btn btn-primary">
                        <i class="fas fa-file-export"></i> Export HTML
                    </button>
                </div>
            </div>

            <div class="main-content">
                <div class="image-container" id="imageContainer">
                    <div class="empty-state" id="emptyState">
                        <i class="fas fa-image" style="font-size: 48px; margin-bottom: 20px; color: #dee2e6;"></i>
                        <div>Upload an image to get started</div>
                    </div>
                    <img id="imageDisplay" alt="Uploaded image">
                    <div class="marker-popup" id="markerPopup">
                        <div class="popup-header">
                            <h4 class="popup-title" id="popupTitle"></h4>
                            <button class="popup-close" id="closePopup">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="popup-content">
                            <p class="popup-description" id="popupDescription"></p>
                            <a class="popup-link" id="popupLink" href="#" target="_blank" style="display: none;"></a>
                            <div class="popup-media" id="popupMedia"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Simple state management
        let markers = [];
        let currentMarkerType = 'info';
        let selectedMarkerId = null;
        let currentImage = null;

        // DOM elements
        const fileInput = document.getElementById('fileInput');
        const imageUpload = document.getElementById('imageUpload');
        const imageDisplay = document.getElementById('imageDisplay');
        const imageContainer = document.getElementById('imageContainer');
        const emptyState = document.getElementById('emptyState');
        const markerTypes = document.querySelectorAll('.marker-type');
        const markerTitle = document.getElementById('markerTitle');
        const markerDescription = document.getElementById('markerDescription');
        const markerLink = document.getElementById('markerLink');
        const markerVideo = document.getElementById('markerVideo');
        const markerAudio = document.getElementById('markerAudio');
        const linkField = document.querySelector('.link-field');
        const videoField = document.querySelector('.video-field');
        const audioField = document.querySelector('.audio-field');
        const saveMarker = document.getElementById('saveMarker');
        const deleteMarker = document.getElementById('deleteMarker');
        const clearMarkers = document.getElementById('clearMarkers');
        const markerList = document.getElementById('markerList');
        const saveProject = document.getElementById('saveProject');
        const loadProject = document.getElementById('loadProject');
        const exportHTML = document.getElementById('exportHTML');
        const markerPopup = document.getElementById('markerPopup');
        const popupTitle = document.getElementById('popupTitle');
        const popupDescription = document.getElementById('popupDescription');
        const popupLink = document.getElementById('popupLink');
        const popupMedia = document.getElementById('popupMedia');
        const closePopup = document.getElementById('closePopup');

        // Initialize app
        function init() {
            console.log('App initialized');
            
            // Event listeners
            fileInput.addEventListener('click', () => {
                imageUpload.click();
            });

            imageUpload.addEventListener('change', handleImageUpload);

            markerTypes.forEach(type => {
                type.addEventListener('click', () => {
                    markerTypes.forEach(t => t.classList.remove('active'));
                    type.classList.add('active');
                    currentMarkerType = type.dataset.type;
                    updateFieldsVisibility();
                });
            });

            saveMarker.addEventListener('click', saveMarkerHandler);
            deleteMarker.addEventListener('click', deleteMarkerHandler);
            clearMarkers.addEventListener('click', clearMarkersHandler);
            saveProject.addEventListener('click', saveProjectHandler);
            loadProject.addEventListener('click', loadProjectHandler);
            exportHTML.addEventListener('click', exportHTMLHandler);
            closePopup.addEventListener('click', hidePopup);

            imageDisplay.addEventListener('click', addMarker);

            updateFieldsVisibility();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = {
                        src: e.target.result,
                        width: img.width,
                        height: img.height
                    };
                    
                    imageDisplay.src = currentImage.src;
                    imageDisplay.style.display = 'block';
                    emptyState.style.display = 'none';
                    
                    markers = [];
                    updateMarkerList();
                    renderAllMarkers();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function addMarker(event) {
            if (!currentImage) {
                alert('Please upload an image first!');
                return;
            }

            const containerRect = imageContainer.getBoundingClientRect();
            const imgRect = imageDisplay.getBoundingClientRect();
            
            // Calculate click position relative to the actual image
            const clickX = event.clientX - imgRect.left;
            const clickY = event.clientY - imgRect.top;
            
            // Convert to image coordinates (percentage based)
            const imageX = (clickX / imgRect.width) * 100;
            const imageY = (clickY / imgRect.height) * 100;
            
            // Also store absolute pixel position for display
            const displayX = event.clientX - containerRect.left;
            const displayY = event.clientY - containerRect.top;

            const marker = {
                id: Date.now(),
                type: currentMarkerType,
                x: imageX,
                y: imageY,
                displayX: displayX,
                displayY: displayY,
                title: markerTitle.value || 'New Marker',
                description: markerDescription.value || '',
                link: markerLink.value || '',
                video: markerVideo.value || '',
                audio: markerAudio.value || ''
            };

            markers.push(marker);
            renderMarker(marker);
            updateMarkerList();

            // Clear form
            markerTitle.value = '';
            markerDescription.value = '';
            markerLink.value = '';
            markerVideo.value = '';
            markerAudio.value = '';
            
            // Reset to add mode
            resetForm();
        }

        function renderMarker(marker) {
            const markerElement = document.createElement('div');
            markerElement.className = 'marker ' + marker.type;
            
            markerElement.style.left = marker.displayX + 'px';
            markerElement.style.top = marker.displayY + 'px';
            markerElement.dataset.id = marker.id;

            // Add icon based on type
            let icon = '';
            if (marker.type === 'info') icon = '<i class="fas fa-info-circle"></i>';
            else if (marker.type === 'link') icon = '<i class="fas fa-link"></i>';
            else if (marker.type === 'video') icon = '<i class="fas fa-video"></i>';
            else if (marker.type === 'audio') icon = '<i class="fas fa-volume-up"></i>';
            
            markerElement.innerHTML = icon;

            markerElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectMarker(marker.id);
                showMarkerInfo(marker);
            });

            imageContainer.appendChild(markerElement);
        }

        function renderAllMarkers() {
            // Clear existing markers
            document.querySelectorAll('.marker').forEach(marker => marker.remove());
            
            // Recalculate display positions for all markers
            markers.forEach(marker => {
                const imgRect = imageDisplay.getBoundingClientRect();
                const containerRect = imageContainer.getBoundingClientRect();
                
                marker.displayX = (marker.x / 100) * imgRect.width + (imgRect.left - containerRect.left);
                marker.displayY = (marker.y / 100) * imgRect.height + (imgRect.top - containerRect.top);
                
                renderMarker(marker);
            });
        }

        function selectMarker(markerId) {
            // Deselect all markers
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.marker-item').forEach(m => m.classList.remove('selected'));
            
            // Select the clicked marker
            const markerElement = document.querySelector(`.marker[data-id="${markerId}"]`);
            const markerItem = document.querySelector(`.marker-item[data-id="${markerId}"]`);
            
            if (markerElement) markerElement.classList.add('selected');
            if (markerItem) markerItem.classList.add('selected');
            
            selectedMarkerId = markerId;
            
            // Show delete button
            deleteMarker.style.display = 'inline-block';
        }

        function showMarkerInfo(marker) {
            popupTitle.textContent = marker.title;
            popupDescription.textContent = marker.description;
            
            // Clear previous media
            popupMedia.innerHTML = '';
            popupLink.style.display = 'none';
            
            // Show appropriate content based on marker type
            if (marker.type === 'link' && marker.link) {
                popupLink.href = marker.link;
                popupLink.textContent = marker.link;
                popupLink.style.display = 'block';
            }
            else if (marker.type === 'video' && marker.video) {
                const videoElement = createMediaElement(marker.video, 'video');
                popupMedia.appendChild(videoElement);
            }
            else if (marker.type === 'audio' && marker.audio) {
                const audioElement = createMediaElement(marker.audio, 'audio');
                popupMedia.appendChild(audioElement);
            }

            // Position popup with boundary checking
            const popupWidth = markerPopup.offsetWidth;
            const popupHeight = markerPopup.offsetHeight;
            const containerRect = imageContainer.getBoundingClientRect();
            
            let left = marker.displayX + 20;
            let top = marker.displayY - 20;
            
            // Check if popup would go outside container
            if (left + popupWidth > containerRect.width) {
                left = marker.displayX - popupWidth - 20;
            }
            if (top + popupHeight > containerRect.height) {
                top = marker.displayY - popupHeight + 20;
            }
            
            markerPopup.style.left = left + 'px';
            markerPopup.style.top = top + 'px';
            markerPopup.style.display = 'block';
        }

        function createMediaElement(url, type) {
            if (type === 'video') {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('vimeo.com')) {
                    const embedUrl = getEmbedUrl(url);
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.width = '100%';
                    iframe.height = '200';
                    iframe.style.border = 'none';
                    iframe.style.borderRadius = '4px';
                    iframe.allowFullscreen = true;
                    return iframe;
                } else {
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.className = 'popup-video';
                    video.style.width = '100%';
                    video.style.maxHeight = '200px';
                    return video;
                }
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.className = 'popup-audio';
                audio.style.width = '100%';
                return audio;
            }
        }

        function getEmbedUrl(url) {
            // YouTube embed
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                if (url.includes('youtube.com')) {
                    videoId = new URL(url).searchParams.get('v');
                } else if (url.includes('youtu.be')) {
                    videoId = url.split('/').pop().split('?')[0];
                }
                return 'https://www.youtube.com/embed/' + videoId;
            }
            // Vimeo embed
            else if (url.includes('vimeo.com')) {
                const videoId = url.split('/').pop();
                return 'https://player.vimeo.com/video/' + videoId;
            }
            return url;
        }

        function hidePopup() {
            markerPopup.style.display = 'none';
        }

        function saveMarkerHandler() {
            if (selectedMarkerId) {
                // Update existing marker
                const marker = markers.find(m => m.id === selectedMarkerId);
                if (marker) {
                    marker.title = markerTitle.value;
                    marker.description = markerDescription.value;
                    marker.link = markerLink.value;
                    marker.video = markerVideo.value;
                    marker.audio = markerAudio.value;
                    marker.type = currentMarkerType;
                    updateMarkerList();
                    renderAllMarkers();
                    alert('Marker updated!');
                }
            } else {
                alert('Click on the image to add a marker first');
            }
        }

        function deleteMarkerHandler() {
            if (selectedMarkerId && confirm('Delete this marker?')) {
                markers = markers.filter(m => m.id !== selectedMarkerId);
                document.querySelector(`.marker[data-id="${selectedMarkerId}"]`).remove();
                updateMarkerList();
                hidePopup();
                resetForm();
                selectedMarkerId = null;
            }
        }

        function clearMarkersHandler() {
            if (confirm('Clear all markers?')) {
                markers = [];
                document.querySelectorAll('.marker').forEach(m => m.remove());
                updateMarkerList();
                hidePopup();
                resetForm();
            }
        }

        function updateMarkerList() {
            if (markers.length === 0) {
                markerList.innerHTML = '<div class="empty-state">No markers added</div>';
                return;
            }

            let html = '';
            markers.forEach(marker => {
                let icon = '';
                if (marker.type === 'info') icon = '<i class="fas fa-info-circle"></i>';
                else if (marker.type === 'link') icon = '<i class="fas fa-link"></i>';
                else if (marker.type === 'video') icon = '<i class="fas fa-video"></i>';
                else if (marker.type === 'audio') icon = '<i class="fas fa-volume-up"></i>';

                html += '<div class="marker-item" data-id="' + marker.id + '">' +
                    '<div class="marker-item-content">' +
                        '<div class="marker-item-icon ' + marker.type + '">' + icon + '</div>' +
                        '<div><strong>' + marker.title + '</strong><br><small>' + marker.type + '</small></div>' +
                    '</div>' +
                    '<div class="marker-actions">' +
                        '<button class="marker-action-btn edit-marker" title="Edit"><i class="fas fa-edit"></i></button>' +
                        '<button class="marker-action-btn delete-marker" title="Delete"><i class="fas fa-trash"></i></button>' +
                    '</div>' +
                '</div>';
            });

            markerList.innerHTML = html;

            // Add click events to marker items
            markerList.querySelectorAll('.marker-item').forEach(item => {
                const markerId = parseInt(item.dataset.id);
                const marker = markers.find(m => m.id === markerId);
                
                // Click on item selects marker
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.marker-actions')) {
                        selectMarker(markerId);
                        showMarkerInfo(marker);
                    }
                });
                
                // Edit button
                item.querySelector('.edit-marker').addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectMarker(markerId);
                    
                    // Populate form with marker data
                    markerTitle.value = marker.title;
                    markerDescription.value = marker.description;
                    markerLink.value = marker.link;
                    markerVideo.value = marker.video;
                    markerAudio.value = marker.audio;
                    
                    // Set the correct marker type active
                    markerTypes.forEach(t => t.classList.remove('active'));
                    document.querySelector('.marker-type[data-type="' + marker.type + '"]').classList.add('active');
                    currentMarkerType = marker.type;
                    updateFieldsVisibility();
                });
                
                // Delete button
                item.querySelector('.delete-marker').addEventListener('click', (e) => {
                    e.stopPropagation();
                    markers = markers.filter(m => m.id !== markerId);
                    document.querySelector(`.marker[data-id="${markerId}"]`).remove();
                    updateMarkerList();
                    if (selectedMarkerId === markerId) {
                        hidePopup();
                        resetForm();
                        selectedMarkerId = null;
                    }
                });
            });
        }

        function updateFieldsVisibility() {
            // Hide all fields first
            linkField.style.display = 'none';
            videoField.style.display = 'none';
            audioField.style.display = 'none';
            
            // Show only the relevant field
            if (currentMarkerType === 'link') {
                linkField.style.display = 'block';
            } else if (currentMarkerType === 'video') {
                videoField.style.display = 'block';
            } else if (currentMarkerType === 'audio') {
                audioField.style.display = 'block';
            }
        }

        function resetForm() {
            markerTitle.value = '';
            markerDescription.value = '';
            markerLink.value = '';
            markerVideo.value = '';
            markerAudio.value = '';
            deleteMarker.style.display = 'none';
            selectedMarkerId = null;
            
            // Deselect all markers
            document.querySelectorAll('.marker').forEach(m => m.classList.remove('selected'));
            document.querySelectorAll('.marker-item').forEach(m => m.classList.remove('selected'));
            
            // Reset to info marker type
            markerTypes.forEach(t => t.classList.remove('active'));
            document.querySelector('.marker-type[data-type="info"]').classList.add('active');
            currentMarkerType = 'info';
            updateFieldsVisibility();
        }

        function saveProjectHandler() {
            if (!currentImage) {
                alert('Please upload an image first');
                return;
            }

            const projectName = prompt('Project name:');
            if (!projectName) return;

            const project = {
                name: projectName,
                image: currentImage,
                markers: markers,
                date: new Date().toISOString()
            };

            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            projects.push(project);
            localStorage.setItem('projects', JSON.stringify(projects));
            alert('Project saved!');
        }

        function loadProjectHandler() {
            const projects = JSON.parse(localStorage.getItem('projects') || '[]');
            if (projects.length === 0) {
                alert('No saved projects');
                return;
            }

            const projectNames = projects.map(p => p.name).join('\n');
            const projectName = prompt('Available projects:\n' + projectNames + '\n\nEnter project name:');
            
            const project = projects.find(p => p.name === projectName);
            if (project) {
                currentImage = project.image;
                markers = project.markers || [];
                
                imageDisplay.src = currentImage.src;
                imageDisplay.style.display = 'block';
                emptyState.style.display = 'none';
                
                // Recalculate image position
                setTimeout(() => {
                    renderAllMarkers();
                    updateMarkerList();
                    resetForm();
                    alert('Project loaded!');
                }, 100);
            } else {
                alert('Project not found');
            }
        }

        function exportHTMLHandler() {
            if (!currentImage || markers.length === 0) {
                alert('Please create a project with markers first');
                return;
            }

            const projectName = prompt('Project name for export:') || 'Interactive Image';
            
            const html = createExportHTML(projectName);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = projectName.replace(/ /g, '_') + '.html';
            a.click();
            
            alert('HTML file exported!');
        }

        function createExportHTML(projectName) {
            return `<!DOCTYPE html>
<html>
<head>
    <title>${projectName}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { margin: 20px; text-align: center; font-family: Arial, sans-serif; background: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .image-container { position: relative; display: inline-block; max-width: 100%; margin: 20px 0; }
        img { max-width: 100%; height: auto; border-radius: 5px; }
        .marker { position: absolute; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); transition: transform 0.2s; }
        .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
        .marker.info { background: #17a2b8; }
        .marker.link { background: #28a745; }
        .marker.video { background: #dc3545; }
        .marker.audio { background: #ffc107; }
        .popup { position: absolute; background: white; border: 1px solid #ccc; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: none; z-index: 100; max-width: 350px; min-width: 250px; border-radius: 8px; }
        .popup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .popup-title { color: #4a6fa5; margin: 0; flex: 1; }
        .popup-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #6c757d; }
        .popup-content { margin-bottom: 15px; }
        .popup-description { color: #495057; line-height: 1.4; margin-bottom: 10px; }
        .popup-link { display: block; color: #4a6fa5; text-decoration: none; margin-bottom: 10px; word-break: break-all; }
        .popup-link:hover { text-decoration: underline; }
        .popup-media { width: 100%; margin-top: 10px; }
        .popup-video, .popup-audio { width: 100%; border-radius: 4px; }
        iframe { border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${projectName}</h1>
        <div class="image-container">
            <img src="${currentImage.src}" alt="Interactive Image" id="exportedImage">
            <div id="markers"></div>
            <div class="popup" id="popup">
                <div class="popup-header">
                    <h4 class="popup-title" id="popupTitle"></h4>
                    <button class="popup-close" onclick="document.getElementById('popup').style.display='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="popup-content">
                    <p class="popup-description" id="popupDesc"></p>
                    <a class="popup-link" id="popupLink" href="#" target="_blank" style="display: none;"></a>
                    <div class="popup-media" id="popupMedia"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const markers = ${JSON.stringify(markers)};
        const image = document.getElementById('exportedImage');
        
        function createMediaElement(url, type) {
            if (type === 'video') {
                if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('vimeo.com')) {
                    const embedUrl = getEmbedUrl(url);
                    const iframe = document.createElement('iframe');
                    iframe.src = embedUrl;
                    iframe.width = '100%';
                    iframe.height = '200';
                    iframe.style.border = 'none';
                    iframe.allowFullscreen = true;
                    return iframe;
                } else {
                    const video = document.createElement('video');
                    video.src = url;
                    video.controls = true;
                    video.className = 'popup-video';
                    video.style.width = '100%';
                    video.style.maxHeight = '200px';
                    return video;
                }
            } else if (type === 'audio') {
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.className = 'popup-audio';
                audio.style.width = '100%';
                return audio;
            }
        }
        
        function getEmbedUrl(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                if (url.includes('youtube.com')) {
                    videoId = new URL(url).searchParams.get('v');
                } else if (url.includes('youtu.be')) {
                    videoId = url.split('/').pop().split('?')[0];
                }
                return 'https://www.youtube.com/embed/' + videoId;
            } else if (url.includes('vimeo.com')) {
                const videoId = url.split('/').pop();
                return 'https://player.vimeo.com/video/' + videoId;
            }
            return url;
        }
        
        image.onload = function() {
            const imgRect = image.getBoundingClientRect();
            markers.forEach(marker => {
                const m = document.createElement('div');
                m.className = 'marker ' + marker.type;
                
                const x = (marker.x / 100) * imgRect.width;
                const y = (marker.y / 100) * imgRect.height;
                
                m.style.left = x + 'px';
                m.style.top = y + 'px';
                
                let icon = '';
                if (marker.type === 'info') icon = '<i class="fas fa-info-circle"></i>';
                else if (marker.type === 'link') icon = '<i class="fas fa-link"></i>';
                else if (marker.type === 'video') icon = '<i class="fas fa-video"></i>';
                else if (marker.type === 'audio') icon = '<i class="fas fa-volume-up"></i>';
                m.innerHTML = icon;
                
                m.onclick = function(e) {
                    e.stopPropagation();
                    document.getElementById('popupTitle').textContent = marker.title;
                    document.getElementById('popupDesc').textContent = marker.description;
                    
                    const link = document.getElementById('popupLink');
                    const media = document.getElementById('popupMedia');
                    media.innerHTML = '';
                    link.style.display = 'none';
                    
                    if (marker.type === 'link' && marker.link) {
                        link.href = marker.link;
                        link.textContent = marker.link;
                        link.style.display = 'block';
                    } else if (marker.type === 'video' && marker.video) {
                        const videoElement = createMediaElement(marker.video, 'video');
                        media.appendChild(videoElement);
                    } else if (marker.type === 'audio' && marker.audio) {
                        const audioElement = createMediaElement(marker.audio, 'audio');
                        media.appendChild(audioElement);
                    }
                    
                    document.getElementById('popup').style.left = (x + 40) + 'px';
                    document.getElementById('popup').style.top = (y - 20) + 'px';
                    document.getElementById('popup').style.display = 'block';
                };
                document.getElementById('markers').appendChild(m);
            });
        };
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.marker') && !e.target.closest('.popup')) {
                document.getElementById('popup').style.display = 'none';
            }
        });
        
        window.addEventListener('resize', function() {
            document.getElementById('markers').innerHTML = '';
            if (image.complete) {
                image.onload();
            }
        });
    <\/script>
</body>
</html>`;
        }

        // Handle window resize to reposition markers
        window.addEventListener('resize', function() {
            if (currentImage) {
                renderAllMarkers();
            }
        });

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
